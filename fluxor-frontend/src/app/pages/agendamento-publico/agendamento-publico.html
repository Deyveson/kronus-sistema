<div class="agendamento-container">
  <!-- Header -->
  <div class="page-header">
    <mat-icon class="header-icon">event_note</mat-icon>
    <h1 class="header-title">Agendamento Online</h1>
    <p class="header-subtitle">Agende sua consulta de forma rápida, fácil e segura</p>
  </div>

  <!-- Progress Card -->
  <div class="progress-card">
    <div class="progress-steps">
      <div class="step" [class.active]="etapaAtual === 1" [class.completed]="etapaAtual > 1">
        <div class="step-circle">
          <mat-icon *ngIf="etapaAtual > 1">check</mat-icon>
          <span *ngIf="etapaAtual <= 1">1</span>
        </div>
        <span class="step-label">Identificação</span>
      </div>
      <div class="step-line" [class.completed]="etapaAtual > 1"></div>
      <div class="step" [class.active]="etapaAtual === 2" [class.completed]="etapaAtual > 2">
        <div class="step-circle">
          <mat-icon *ngIf="etapaAtual > 2">check</mat-icon>
          <span *ngIf="etapaAtual <= 2">2</span>
        </div>
        <span class="step-label">Cadastro</span>
      </div>
      <div class="step-line" [class.completed]="etapaAtual > 2"></div>
      <div class="step" [class.active]="etapaAtual === 3" [class.completed]="etapaAtual > 3">
        <div class="step-circle">
          <mat-icon *ngIf="etapaAtual > 3">check</mat-icon>
          <span *ngIf="etapaAtual <= 3">3</span>
        </div>
        <span class="step-label">Agendamento</span>
      </div>
      <div class="step-line" [class.completed]="etapaAtual > 3"></div>
      <div class="step" [class.active]="etapaAtual === 4" [class.completed]="etapaAtual > 4">
        <div class="step-circle">
          <mat-icon *ngIf="etapaAtual > 4">check</mat-icon>
          <span *ngIf="etapaAtual <= 4">4</span>
        </div>
        <span class="step-label">Confirmação</span>
      </div>
    </div>
    <div class="progress-bar-container">
      <span class="progress-label">Progresso</span>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="(etapaAtual / 4) * 100"></div>
      </div>
      <span class="progress-percent">{{ (etapaAtual / 4) * 100 | number:'1.0-0' }} %</span>
    </div>
  </div>

  <!-- Main Content Card -->
  <div class="content-card">
    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Carregando...</p>
    </div>

    <!-- ETAPA 1: Identificação (CPF) -->
    <div *ngIf="etapaAtual === 1 && !loading" class="etapa">
      <div class="etapa-header gradient-pink-purple">
        <mat-icon>search</mat-icon>
        <div>
          <h2>Vamos começar!</h2>
          <p>Digite seu CPF para continuar</p>
        </div>
      </div>

      <div class="etapa-content">
        <div class="form-group">
          <label class="form-label">CPF *</label>
          <div class="input-with-icon">
            <mat-icon>person_outline</mat-icon>
            <input type="text" [(ngModel)]="cpf" placeholder="000.000.000-00" maxlength="14" class="form-input">
          </div>
          <span class="form-hint">Digite apenas os números do seu CPF</span>
        </div>

        <button class="btn-primary btn-full" (click)="validarCpf()" [disabled]="!cpf || cpf.length < 11">
          <mat-icon>search</mat-icon>
          Verificador CPF
        </button>
      </div>
    </div>

    <!-- ETAPA 2: Cadastro (quando CPF não encontrado) -->
    <div *ngIf="etapaAtual === 2 && !loading" class="etapa">
      <div class="etapa-header gradient-blue-purple">
        <mat-icon>auto_awesome</mat-icon>
        <div>
          <h2>Novo por aqui?</h2>
          <p>Vamos criar seu cadastro rapidinho!</p>
        </div>
      </div>

      <div class="etapa-content">
        <div class="info-alert" *ngIf="!cliente">
          <mat-icon>info</mat-icon>
          <span>CPF não encontrado. Por favor, complete seu cadastro para continuar.</span>
        </div>

        <div class="form-group">
          <label class="form-label">Nome Completo *</label>
          <div class="input-with-icon">
            <mat-icon>person_outline</mat-icon>
            <input type="text" [(ngModel)]="novoCliente.nome" placeholder="Digite seu nome completo" class="form-input">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Telefone *</label>
            <div class="input-with-icon">
              <mat-icon>phone</mat-icon>
              <input type="text" [(ngModel)]="novoCliente.telefone" placeholder="(00) 00000-0000" class="form-input">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Data de Nascimento</label>
            <div class="input-with-icon">
              <mat-icon>cake</mat-icon>
              <input type="date" [(ngModel)]="novoCliente.dataNascimento" class="form-input">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">E-mail *</label>
          <div class="input-with-icon">
            <mat-icon>email</mat-icon>
            <input type="email" [(ngModel)]="novoCliente.email" placeholder="seu@email.com" class="form-input">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Gênero</label>
          <div class="input-with-icon">
            <mat-icon>wc</mat-icon>
            <select [(ngModel)]="novoCliente.genero" class="form-input form-select">
              <option value="">Selecione...</option>
              <option value="masculino">Masculino</option>
              <option value="feminino">Feminino</option>
              <option value="outro">Outro</option>
              <option value="prefiro_nao_informar">Prefiro não informar</option>
            </select>
          </div>
        </div>

        <div class="button-group">
          <button class="btn-secondary" (click)="voltarEtapa()">
            <mat-icon>arrow_back</mat-icon>
            Voltar
          </button>
          <button class="btn-primary" (click)="cadastrarCliente()" 
                  [disabled]="!novoCliente.nome || !novoCliente.telefone || !novoCliente.email">
            <mat-icon>check</mat-icon>
            Cadastrar e Continuar
          </button>
        </div>
      </div>
    </div>

    <!-- ETAPA 3: Agendamento (Data e Horário) -->
    <div *ngIf="etapaAtual === 3 && !loading" class="etapa">
      <div class="etapa-header gradient-pink-purple">
        <mat-icon>event</mat-icon>
        <div>
          <h2>Escolha data e horário</h2>
          <p>Estamos quase lá!</p>
        </div>
      </div>

      <div class="etapa-content">
        <!-- Dados do Paciente -->
        <div class="paciente-info" *ngIf="cliente">
          <div class="paciente-avatar">
            <mat-icon>person</mat-icon>
          </div>
          <div class="paciente-details">
            <h3>{{ cliente.nome }}</h3>
            <p><mat-icon>phone</mat-icon> {{ cliente.telefone }}</p>
            <p><mat-icon>email</mat-icon> {{ cliente.email }}</p>
          </div>
        </div>

        <!-- Seleção de Serviço -->
        <div class="form-group" *ngIf="servicos.length > 0">
          <label class="form-label">Serviço *</label>
          <div class="input-with-icon">
            <mat-icon>medical_services</mat-icon>
            <select [(ngModel)]="servicoSelecionado" (change)="selecionarServico()" class="form-input form-select">
              <option value="">Selecione o serviço...</option>
              <option *ngFor="let servico of servicos" [value]="servico._id">
                {{ servico.nome }} - {{ servico.duracao }}min - R$ {{ servico.preco }}
              </option>
            </select>
          </div>
        </div>

        <!-- Seleção de Profissional -->
        <div class="form-group" *ngIf="profissionais.length > 0">
          <label class="form-label">Profissional *</label>
          <div class="input-with-icon">
            <mat-icon>person_pin</mat-icon>
            <select [(ngModel)]="profissionalSelecionado" (change)="selecionarProfissional()" class="form-input form-select">
              <option value="">Selecione o profissional...</option>
              <option *ngFor="let profissional of profissionais" [value]="profissional._id">
                {{ profissional.nome }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Data *</label>
            <div class="input-with-icon">
              <mat-icon>calendar_today</mat-icon>
              <input type="date" [(ngModel)]="dataSelecionadaInput" (change)="onDataChange()" 
                     [min]="dataMinimaStr" class="form-input">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Horário *</label>
            <div class="input-with-icon">
              <mat-icon>schedule</mat-icon>
              <select [(ngModel)]="horarioSelecionado" class="form-input form-select">
                <option value="">Selecione...</option>
                <option *ngFor="let horario of horariosDisponiveis" [value]="horario">{{ horario }}</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Observações</label>
          <div class="input-with-icon textarea-container">
            <mat-icon>chat_bubble_outline</mat-icon>
            <textarea [(ngModel)]="observacoes" placeholder="Alguma observação ou informação importante?" 
                      class="form-input form-textarea" rows="3"></textarea>
          </div>
        </div>

        <div class="button-group">
          <button class="btn-secondary" (click)="voltarEtapa()">
            <mat-icon>arrow_back</mat-icon>
            Alterar CPF
          </button>
          <button class="btn-primary" (click)="confirmarAgendamento()" 
                  [disabled]="!servicoSelecionado || !profissionalSelecionado || !dataSelecionadaInput || !horarioSelecionado">
            <mat-icon>check</mat-icon>
            Confirmar Agendamento
          </button>
        </div>
      </div>
    </div>

    <!-- ETAPA 4: Confirmação -->
    <div *ngIf="etapaAtual === 4 && !loading" class="etapa">
      <div class="etapa-header gradient-green sucesso-header">
        <div class="sucesso-check">
          <mat-icon>check</mat-icon>
        </div>
        <h2>Agendamento Confirmado!</h2>
        <p>Seu horário está reservado com sucesso</p>
      </div>

      <div class="etapa-content confirmacao-content">
        <!-- Dados do Paciente -->
        <div class="confirmacao-section">
          <div class="section-icon">
            <mat-icon>person</mat-icon>
          </div>
          <div class="section-content">
            <h4>Paciente</h4>
            <p class="section-title">{{ cliente?.nome }}</p>
            <p class="section-detail"><mat-icon>phone</mat-icon> {{ cliente?.telefone }}</p>
            <p class="section-detail"><mat-icon>email</mat-icon> {{ cliente?.email }}</p>
          </div>
        </div>

        <!-- Data e Horário -->
        <div class="confirmacao-row">
          <div class="confirmacao-box">
            <mat-icon>calendar_today</mat-icon>
            <span class="box-label">DATA</span>
            <span class="box-value">{{ dataSelecionadaInput | date:'dd/MM/yyyy' }}</span>
          </div>
          <div class="confirmacao-box">
            <mat-icon>access_time</mat-icon>
            <span class="box-label">HORÁRIO</span>
            <span class="box-value">{{ horarioSelecionado }}</span>
          </div>
        </div>

        <!-- Botões -->
        <button class="btn-success btn-full">
          <mat-icon>description</mat-icon>
          Ver Comprovante
        </button>

        <button class="btn-outline btn-full" (click)="novoAgendamento()">
          Fazer Novo Agendamento
        </button>

        <!-- Aviso -->
        <div class="aviso-final">
          <mat-icon>info</mat-icon>
          <div>
            <strong>Você receberá uma confirmação por WhatsApp e E-mail</strong>
            <p>Guarde este comprovante para facilitar no dia da consulta</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
